@model IEnumerable<IK_Intranet_App.Models.Gorev>
@using IK_Intranet_App.Enums

@{
    ViewData["Title"] = "Görev Panosu";

    // --- SAYAÇLARI HESAPLA ---
    var countYapilacak = Model.Count(x => x.Durum == Durumlar.Yapilacak);
    var countSuruyor = Model.Count(x => x.Durum == Durumlar.Suruyor);
    var countTamamlandi = Model.Count(x => x.Durum == Durumlar.Tamamlandi);
}

<style>
    .hover-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
        transition: 0.3s;
        cursor: grab;
    }

    .hover-card:active {
        cursor: grabbing;
    }

    .sortable-ghost {
        opacity: 0.4;
        background-color: #e9ecef;
        border: 2px dashed #adb5bd;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h1 class="display-6 fw-bold mb-0">Görev Panosu</h1>

        <a tabindex="0"
           class="btn btn-sm text-muted ms-2 mt-2 opacity-75"
           role="button"
           data-bs-toggle="popover"
           data-bs-trigger="hover focus"
           data-bs-title="Yetki Kuralları"
           data-bs-html="true"
           data-bs-content="
                <div class='small'>
                    <div class='mb-2'>
                        <span class='badge bg-warning text-dark me-1'>Yönetici</span>
                        Her görevi düzenleyebilir, taşıyabilir ve silebilir.
                    </div>
                    <div>
                        <span class='badge bg-primary me-1'>Üye</span>
                        <ul class='mb-0 ps-3 mt-1'>
                            <li><b>Düzenleme/Taşıma:</b> Kendi oluşturduğu veya kendisine atananlar.</li>
                            <li><b>Silme:</b> Sadece kendi oluşturduğu görevler.</li>
                        </ul>
                    </div>
                </div>
           ">
            <i class="bi bi-question-circle-fill fs-5"></i>
        </a>
    </div>

    <a asp-action="Create" class="btn btn-primary btn-lg shadow-sm">
        <i class="bi bi-plus-lg"></i> Yeni Görev
    </a>
</div>

<div id="kanban-scroll-container" class="row flex-nowrap overflow-x-auto pb-4" style="min-height: 75vh;">

    <div class="col-10 col-md-4">
        <div class="card bg-light mb-3 shadow-sm border-0">
            <div class="card-header bg-secondary text-white fw-bold text-center d-flex justify-content-between align-items-center px-4">
                <span>YAPILACAKLAR</span>
                <span class="badge bg-white text-secondary rounded-pill">@countYapilacak</span>
            </div>

            <div id="col-yapilacak" data-status="0" class="card-body sortable-list" style="min-height: 500px; background-color: #f8f9fa;">
                @foreach (var item in Model.Where(x => x.Durum == Durumlar.Yapilacak))
                {
                    <div data-task-id="@item.Id">
                        <partial name="_GorevCardPartial" model="item" />
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-10 col-md-4">
        <div class="card bg-light mb-3 shadow-sm border-0">
            <div class="card-header bg-warning text-dark fw-bold text-center d-flex justify-content-between align-items-center px-4">
                <span>SÜRÜYOR</span>
                <span class="badge bg-white text-dark rounded-pill bg-opacity-75">@countSuruyor</span>
            </div>

            <div id="col-suruyor" data-status="1" class="card-body sortable-list" style="min-height: 500px; background-color: #fffbf0;">
                @foreach (var item in Model.Where(x => x.Durum == Durumlar.Suruyor))
                {
                    <div data-task-id="@item.Id">
                        <partial name="_GorevCardPartial" model="item" />
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-10 col-md-4">
        <div class="card bg-light mb-3 shadow-sm border-0">
            <div class="card-header bg-success text-white fw-bold text-center d-flex justify-content-between align-items-center px-4">
                <span>TAMAMLANDI</span>
                <span class="badge bg-white text-success rounded-pill">@countTamamlandi</span>
            </div>

            <div id="col-tamamlandi" data-status="2" class="card-body sortable-list" style="min-height: 500px; background-color: #f0fff4;">
                @foreach (var item in Model.Where(x => x.Durum == Durumlar.Tamamlandi))
                {
                    <div data-task-id="@item.Id">
                        <partial name="_GorevCardPartial" model="item" />
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

    <script>
        // Popover ayarları
        document.addEventListener("DOMContentLoaded", function(){
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(function (el) { return new bootstrap.Popover(el); });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- 1. MOBİLDE SÜTUN GENİŞLİĞİ AYARI (%75) ---
            const style = document.createElement('style');
            style.innerHTML = `
                @@media (max-width: 768px) {
                    #kanban-scroll-container > .col-10,
                    #kanban-scroll-container > .col-md-4 {
                        flex: 0 0 75vw !important;
                        max-width: 75vw !important;
                        margin-right: 15px !important;
                    }
                }
            `;
            document.head.appendChild(style);

            // --- 2. EVRENSEL AUTO-SCROLL MOTORU ---
            const scrollContainer = document.getElementById('kanban-scroll-container');
            let autoScrollInterval = null;
            let cursorX = 0;
            let cursorY = 0;

            // --- İYİLEŞTİRME BURADA ---
            // Yatayda 50px kenar boşluğu yetiyor (Zaten çalışıyor)
            const scrollZoneX = 50;

            // Dikeyde (Aşağı/Yukarı) alanı genişletiyoruz.
            // 150px yapıyoruz ki parmak en alta sıkışmadan motor devreye girsin.
            const scrollZoneY = 150;

            const speed = 10; // Hız

            // Koordinat Takibi
            const updateCursor = (x, y) => { cursorX = x; cursorY = y; };

            // Mouse Dinleyici
            document.addEventListener('dragover', e => {
                updateCursor(e.clientX, e.clientY);
                checkAutoScroll();
            }, { passive: false });

            // Touch Dinleyici
            document.addEventListener('touchmove', e => {
                if(e.touches[0]) {
                    updateCursor(e.touches[0].clientX, e.touches[0].clientY);
                    if (document.querySelector('.sortable-ghost')) {
                        checkAutoScroll();
                    }
                }
            }, { passive: false });

            // Durdurucular
            const stopScroll = () => {
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                }
            };
            document.addEventListener('dragend', stopScroll);
            document.addEventListener('mouseup', stopScroll);
            document.addEventListener('touchend', stopScroll);

            function checkAutoScroll() {
                if (autoScrollInterval) return;

                autoScrollInterval = setInterval(() => {
                    const screenW = window.innerWidth;
                    const screenH = window.innerHeight;

                    // --- YATAY KAYDIRMA (X Bölgesi Kullanılıyor) ---
                    if (cursorX > screenW - scrollZoneX) {
                        scrollContainer.scrollLeft += speed;
                    } else if (cursorX < scrollZoneX) {
                        scrollContainer.scrollLeft -= speed;
                    }

                    // --- DİKEY KAYDIRMA (Y Bölgesi Kullanılıyor - Daha Geniş) ---
                    // Ekranın altına 150px yaklaştıysan aşağı kaydır
                    if (cursorY > screenH - scrollZoneY) {
                        window.scrollBy(0, speed);
                    }
                    // Ekranın üstüne 150px yaklaştıysan yukarı kaydır
                    else if (cursorY < scrollZoneY) {
                        window.scrollBy(0, -speed);
                    }

                }, 20);
            }

            // --- 3. SORTABLE KURULUMU (Aynen Korundu) ---
            var sortableLists = document.querySelectorAll('.sortable-list');

            sortableLists.forEach(function (list) {
                new Sortable(list, {
                    group: 'kanban-board',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    forceFallback: false,
                    scroll: true,
                    bubbleScroll: true,

                    onEnd: function (evt) {
                        stopScroll();

                        var itemEl = evt.item;
                        var senderList = evt.from;
                        var receiverList = evt.to;
                        var oldIndex = evt.oldIndex;
                        var taskId = itemEl.getAttribute('data-task-id');
                        var newStatus = receiverList.getAttribute('data-status');

                        if (senderList === receiverList) return;

                        updateCounters(senderList, receiverList);

                        fetch('/Gorev/UpdateDurum', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `id=${taskId}&durumId=${newStatus}`
                        })
                        .then(r => r.json())
                        .then(d => {
                            if (!d.success) {
                                setTimeout(() => {
                                    if (senderList.children.length === 0 || oldIndex >= senderList.children.length) {
                                        senderList.appendChild(itemEl);
                                    } else {
                                        senderList.insertBefore(itemEl, senderList.children[oldIndex]);
                                    }
                                    updateCounters(receiverList, senderList);
                                }, 10);
                            }
                        })
                        .catch(e => location.reload());
                    }
                });
            });
        });

        function updateCounters(fromList, toList) {
            var fromBadge = fromList.closest('.card').querySelector('.badge');
            var toBadge = toList.closest('.card').querySelector('.badge');
            if(fromBadge) fromBadge.innerText = Math.max(0, parseInt(fromBadge.innerText) - 1);
            if(toBadge) toBadge.innerText = parseInt(toBadge.innerText) + 1;
        }
    </script>
}